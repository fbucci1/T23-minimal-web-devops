apiVersion: apps/v1
kind: Deployment
metadata:
  name: depl-vaultagent
  labels:
    app: pod-vaultagent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pod-vaultagent
  template:
    metadata:
      labels:
        app: pod-vaultagent
      annotations:
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/role: 'role-app1'
        vault.hashicorp.com/agent-inject-secret-app1.properties: 'secret/app1'
        vault.hashicorp.com/agent-inject-template-app1.properties: |
          # Properties file automatically generated by Vault inject agent
          {{ with secret "/secret/app1 "}}{{ range $k, $v := .Data.data }}{{ $k }}={{ $v }}
          {{ end }}{{ end }}
    spec:
      serviceAccountName: internal-app1
      containers:
        - name: cont-vaultagent
          image: t23-minimal-web-w-lanzador
          imagePullPolicy: Never
          env:
          - name: T23_FILE_PATH
            value: /vault/secrets/app1.properties
          - name: T23_LA_CMD_APP
            value: "node ../../T23-minimal-web/src/server.js > /tmp/server.js.log 2>&1"
          ports:
          - containerPort: 3000
